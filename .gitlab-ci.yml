variables:
  DOCKER_BUILDKIT: 1
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - build

build-image:
  image: docker:24
  services:
    - docker:24-dind
  script:
    # Install buildx and QEMU emulation
    - apk add curl
    - mkdir -p ~/.docker/cli-plugins
    - curl -L https://github.com/docker/buildx/releases/download/v0.10.0/buildx-v0.10.0.linux-amd64 > ~/.docker/cli-plugins/docker-buildx
    - chmod +x ~/.docker/cli-plugins/docker-buildx
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    # Build and push multi-arch image
    - docker buildx create --use
    - docker buildx build --push \
        --platform linux/amd64,linux/arm64 \  # amd64 = Intel, arm64 = ARM
        -t $CI_REGISTRY_IMAGE:latest .
